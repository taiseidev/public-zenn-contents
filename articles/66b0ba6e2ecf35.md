---
title: "🎋 ThemeExtensionを活用して複雑なデザイン要件に対応する"
emoji: "🎋"
type: "tech"
topics:
  - "flutter"
  - "design"
  - "dart"
  - "extension"
  - "theme"
published: false
publication_name: "arsaga"
---

## はじめに
Flutterはアプリで統一的なデザインを作成するためにThemeというクラスが提供されています。Themeを用いることで、デザインの変更を最小限に抑えたり、ダークモードの対応を簡単に行うことが出来ます。

https://docs.flutter.dev/cookbook/design/themes
https://itome.team/blog/2019/12/flutter-advent-calendar-day12/

しかし、アプリの規模やデザインが複雑になるにつれてFlutter標準のThemeだけではデザイン要件を満たすことが難しい場合があります。

## 標準Themeの課題

例えば、チャット画面においてユーザの種類によってチャットバブルのスタイルを変更するといった要件があるとします。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/3f0aa3d125d3-20240113.png =300x)

```dart
class ChatMessage {
  ChatMessage({
    required this.message,
    required this.isMe,
  });

  String message;
  bool isMe;
}

class ChatBubble extends StatelessWidget {
  final ChatMessage msg;

  const ChatBubble({
    super.key,
    required this.msg,
  });

  @override
  Widget build(BuildContext context) {
    return Align(
      alignment: msg.isMe ? Alignment.centerRight : Alignment.centerLeft,
      child: Container(
        padding: const EdgeInsets.symmetric(
          horizontal: 15.0,
          vertical: 10.0,
        ),
        decoration: BoxDecoration(
          color: msg.isMe
              ? Theme.of(context).colorScheme.primary
              : Theme.of(context).colorScheme.secondary,
          borderRadius: BorderRadius.circular(20),
        ),
        child: Text(
          msg.message,
          style: Theme.of(context).textTheme.titleMedium?.copyWith(
                color: msg.isMe ? Colors.white : Colors.grey[400],
              ),
        ),
      ),
    );
  }
}

// MaterialApp部分
      theme: ThemeData(
        useMaterial3: true,
        textTheme: const TextTheme(
          titleMedium: TextStyle(
            color: Colors.white,
            fontWeight: FontWeight.bold,
          ),
        ),
      ),
```

`isMe`で自分のメッセージか相手のメッセージかを判別してスタイルを変更しています。

まずチャットバブルの背景色部分ですが、もしcolorSchemeが変更なった場合、当然ですがチャットバブルの背景色も変更されます。

```dart
color: msg.isMe
    ? Theme.of(context).colorScheme.primary
    : Theme.of(context).colorScheme.secondary,
```

これが意図した変更であれば良いですがチャットバブルの色は変えずにcolorSchemeを変更したかった場合は当然意図しないバグになり、結局これを防ぐためにViewに直接色を指定することになると思います。

また、テキストのカラー変更部分についてはThemeで設定したtitleMediumのデフォルトのスタイルに対してcopyWithで動的に色を変更しています。

```dart
style: Theme.of(context).textTheme.titleMedium?.copyWith(
      color: msg.isMe ? Colors.white : Colors.grey[400],
    ),
```

これだと結局ChatBubble内に色を直接指定することになり、Theme完結でスタイルを指定することができなくなってしまいます。標準のThemeはこういった動的にスタイルを変更するといったことが出来ません。

もしこの状態でダークモードの対応が追加になったり、第三者もメッセージを送れるようにしてスタイルも変更したいといった仕様が追加になった場合、さらにViewが複雑になり保守が困難になります。可能であればViewにスタイルは指定せずTheme完結でスタイルを指定したいところです。

このようなアプリの複雑なデザインに対応するため、Flutter3.0から**ThemeExtension**というAPIが追加されました。ThemeExtensionを活用することによってアプリ独自のデザイン要件に沿った開発を行うことが出来ます。

https://www.youtube.com/watch?v=8-szcYzFVao
https://main-api.flutter.dev/flutter/material/ThemeExtension-class.html

## ThemeExtensionとは？

ThemeExtensionは、標準のThemeを拡張可能にし、デフォルトのThemeDataにはない追加のプロパティやスタイルを定義することが出来ます。先ほどのチャットバブルの例のよう動的にスタイルを変更したいといった要件もThemeのみで実現することができるようになります。

ThemeExtensionの使い方についてはすでに詳しく書かれている記事が存在するのでこの記事では解説しません。

https://lab.mo-t.com/blog/flutter-decoding-theme-extension
https://blog.flutteruniv.com/flutter-themeextension/

## チャットバブルにThemeExtensionを適用する
先ほどのチャットバブルにThemeExtensionを適用していきます。

### 1. ThemeExtension継承クラスを作成する
今回は各ユーザのメッセージの背景とテキストスタイルを変更できるようにします。ThemeExtensionを使用するためにはThemeExtensionを継承したクラスを作成する必要があります。

```dart
class ChatBubbleTheme extends ThemeExtension<ChatBubbleTheme> {
  final Color myMessageBackgroundColor;
  final Color otherMessageBackgroundColor;
  final TextStyle myMessageTextStyle;
  final TextStyle otherMessageTextStyle;

  ChatBubbleTheme({
    required this.myMessageBackgroundColor,
    required this.otherMessageBackgroundColor,
    required this.myMessageTextStyle,
    required this.otherMessageTextStyle,
  });

  @override
  ChatBubbleTheme copyWith({
    Color? myMessageBackgroundColor,
    Color? otherMessageBackgroundColor,
    TextStyle? myMessageTextStyle,
    TextStyle? otherMessageTextStyle,
  }) {
    return ChatBubbleTheme(
      myMessageBackgroundColor:
          myMessageBackgroundColor ?? this.myMessageBackgroundColor,
      otherMessageBackgroundColor:
          otherMessageBackgroundColor ?? this.otherMessageBackgroundColor,
      myMessageTextStyle: myMessageTextStyle ?? this.myMessageTextStyle,
      otherMessageTextStyle:
          otherMessageTextStyle ?? this.otherMessageTextStyle,
    );
  }

  @override
  ChatBubbleTheme lerp(ThemeExtension<ChatBubbleTheme>? other, double t) {
    if (other is! ChatBubbleTheme) {
      return this;
    }
    return ChatBubbleTheme(
      myMessageBackgroundColor: Color.lerp(
          myMessageBackgroundColor, other.myMessageBackgroundColor, t)!,
      otherMessageBackgroundColor: Color.lerp(
          otherMessageBackgroundColor, other.otherMessageBackgroundColor, t)!,
      myMessageTextStyle:
          TextStyle.lerp(myMessageTextStyle, other.myMessageTextStyle, t)!,
      otherMessageTextStyle: TextStyle.lerp(
          otherMessageTextStyle, other.otherMessageTextStyle, t)!,
    );
  }
}
```
長いし複雑ですね...
ただ、実際はオブジェクトをコピーする`copyWith`メソッドと滑らかなスタイルの変更を作り出す`lerp`メソッドをoverrideして実装しているだけなので、特にテクニックが必要とかではありません。

### 2. ThemeExtension継承クラスをコンポーネントに適用する

ChatBubbleコンポーネントに先ほど作成したThemeExtension継承クラスを作成します。

```dart
class ChatBubble extends StatelessWidget {
  final ChatMessage msg;

  const ChatBubble({
    super.key,
    required this.msg,
    this.style,
  });

  final ChatBubbleTheme? style;

  @override
  Widget build(BuildContext context) {
    final chatBubbleTheme = Theme.of(context).extension<ChatBubbleTheme>();
    final myMessageBackgroundColor = style?.myMessageBackgroundColor ??
        chatBubbleTheme?.myMessageBackgroundColor;
    final otherMessageBackgroundColor = style?.otherMessageBackgroundColor ??
        chatBubbleTheme?.otherMessageBackgroundColor;
    final myMessageTextStyle =
        style?.myMessageTextStyle ?? chatBubbleTheme?.myMessageTextStyle;
    final otherMessageTextStyle =
        style?.otherMessageTextStyle ?? chatBubbleTheme?.otherMessageTextStyle;

    return Align(
      alignment: msg.isMe ? Alignment.centerRight : Alignment.centerLeft,
      child: Container(
        padding: const EdgeInsets.symmetric(
          horizontal: 15.0,
          vertical: 10.0,
        ),
        decoration: BoxDecoration(
          color:
              msg.isMe ? myMessageBackgroundColor : otherMessageBackgroundColor,
          borderRadius: BorderRadius.circular(20),
        ),
        child: Text(
          msg.message,
          style: msg.isMe ? myMessageTextStyle : otherMessageTextStyle,
        ),
      ),
    );
  }
}
```

命名が各プロパティに適したものになっているので可読性の高いソースコードになりました。

### 3. MaterialAppにThemeExtensionの設定追加

ThemeExtension継承クラスをThemeDataのextensionsに指定します。

```dart
    return MaterialApp(
      title: 'ThemeExtension Sample',
      theme: ThemeData(
        useMaterial3: true,
        extensions: <ThemeExtension>[
          ChatBubbleTheme(
            myMessageBackgroundColor: Colors.teal,
            otherMessageBackgroundColor: Colors.orange,
            myMessageTextStyle: const TextStyle(
              color: Color.fromARGB(255, 51, 66, 65),
              fontWeight: FontWeight.bold,
            ),
            otherMessageTextStyle: const TextStyle(
              color: Color.fromARGB(255, 255, 248, 239),
              fontWeight: FontWeight.bold,
            ),
          )
        ],
      ),
      home: ChatScreen(),
    );
```

以上でThemeExtensionの設定が完了です。
チャットバブルのスタイルが変更されたり、新しくスタイルを追加したい場合はこの`ChatBubbleTheme`のみを見ればいいので、保守がかなり楽になりました。

![altテキスト](https://storage.googleapis.com/zenn-user-upload/e9430ead0932-20240113.png =300x)

## まとめ
ThemeExtensionを利用することで、一貫性を保ちつつ、さまざまなデザインニーズに柔軟に対応できるようになります。複雑なデザインの反映についてお悩みの方はぜひ導入してみてください！

いやでもやっぱりソースコード長いし導入コスト高い。
そんな方には下記の記事をお勧めします！
https://zenn.dev/arsaga/articles/09bc0e213edf3e

## 参考
https://lab.mo-t.com/blog/flutter-decoding-theme-extension
https://blog.flutteruniv.com/flutter-themeextension/
